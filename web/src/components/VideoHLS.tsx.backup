import React, { useEffect, useRef, useState } from "react";
import Hls from "hls.js";

export default function VideoHLS({ camId, hlsUrl, title }: { camId: string; hlsUrl: string; title?: string; }) {
  const videoRef = useRef<HTMLVideoElement>(null);
  const [error, setError] = useState<string | null>(null);
  const [online, setOnline] = useState(false);
  const hlsRef = useRef<Hls | null>(null);

  useEffect(() => {
    const video = videoRef.current;
    if (!video) return;

    if (hlsRef.current) { hlsRef.current.destroy(); hlsRef.current = null; }
    setError(null); setOnline(false);

    if (Hls.isSupported()) {
      const hls = new Hls({ lowLatencyMode: true, enableWorker: true });
      hlsRef.current = hls;
      hls.loadSource(hlsUrl);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => { setOnline(true); video.play().catch(()=>{}); });
      hls.on(Hls.Events.ERROR, (_, data) => {
        if (data.fatal) { setError("No se pudo reproducir el stream."); hls.destroy(); setOnline(false); }
      });
    } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
      video.src = hlsUrl;
      video.addEventListener("loadedmetadata", () => { setOnline(true); video.play().catch(()=>{}); });
      video.addEventListener("error", () => { setError("Error al cargar el stream."); setOnline(false); });
    } else {
      setError("Tu navegador no soporta HLS.");
    }

    return () => { if (hlsRef.current) { hlsRef.current.destroy(); hlsRef.current = null; } };
  }, [hlsUrl]);

  return (
    <div style={{ background:"#fff", borderRadius:12, boxShadow:"0 8px 20px rgba(0,0,0,.06)" }}>
      <div style={{ background:"#111827", color:"#fff", padding:"10px 14px", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
        <strong>{title || camId}</strong>
        <span title={online ? "Online" : "Offline"} style={{ width:10, height:10, borderRadius:999, background: online ? "#10b981" : "#ef4444", display:"inline-block" }} />
      </div>
      <div style={{ background:"#000", aspectRatio:"16/9" }}>
        {error ? (
          <div style={{ color:"#fff", display:"grid", placeItems:"center", height:"100%" }}>⚠️ {error}</div>
        ) : (
          <video ref={videoRef} controls autoPlay muted playsInline style={{ width:"100%", height:"100%" }} />
        )}
      </div>
      <div style={{ fontSize:12, color:"#6b7280", background:"#f9fafb", padding:"8px 12px" }}>
        📹 {camId} · {online ? "● En vivo" : "○ Desconectado"}
      </div>
    </div>
  );
}
